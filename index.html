<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biciusuarios API Client</title>
    <!-- Carga del CDN de Tailwind CSS para un dise√±o moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilo para spinner de carga */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <!-- Overlay de Carga -->
    <div id="loading-overlay" class="hidden">
        <div class="flex flex-col items-center">
            <span class="animate-spin h-10 w-10 border-4 border-blue-500 border-t-transparent rounded-full mb-3"></span>
            <p class="text-blue-600 font-semibold">Procesando...</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="text-center py-6 mb-8 bg-white shadow-md rounded-lg">
            <h1 class="text-4xl font-bold text-blue-600 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 2a1 1 0 011 1v1h-2V3a1 1 0 011-1zM6 3a1 1 0 011-1h1v2H7a1 1 0 01-1-1zM16 3a1 1 0 011-1h1v2h-1a1 1 0 01-1-1zM3 7a1 1 0 011-1h1v2H4a1 1 0 01-1-1zM21 7a1 1 0 011-1h-1v2h1a1 1 0 01-1-1zM3 13a1 1 0 011-1h1v2H4a1 1 0 01-1-1zM21 13a1 1 0 011-1h-1v2h1a1 1 0 01-1-1zM6 18a1 1 0 011-1h1v2H7a1 1 0 01-1-1zM16 18a1 1 0 011-1h1v2h-1a1 1 0 01-1-1zM11 18a1 1 0 011-1v1h-2v-1a1 1 0 011-1z" />
                    <path fill-rule="evenodd" d="M10 21a1 1 0 001 1h2a1 1 0 100-2h-2a1 1 0 00-1 1zM6 9a1 1 0 011-1h10a1 1 0 011 1v6a1 1 0 01-1 1H7a1 1 0 01-1-1V9z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M12 21a1 1 0 01-1-1v-2H6a1 1 0 01-1-1v-2a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1h-5v2a1 1 0 01-1 1zM7 9a1 1 0 000 2h10a1 1 0 100-2H7z" clip-rule="evenodd" />
                </svg>
                Gesti√≥n de Biciusuarios
            </h1>
            <!-- La URL ahora es din√°mica y reescrita para funcionar en Codespaces -->
            <p class="text-gray-500 mt-2">La URL de la API (Flask: 5002) se est√° reescribiendo din√°micamente para Codespaces.</p>
        </header>

        <!-- Contenedor de Alerta/Mensajes -->
        <div id="message-box" class="hidden p-3 mb-6 rounded-lg font-medium transition-opacity duration-300"></div>

        <!-- SECCI√ìN 1: LOGIN/REGISTER -->
        <section id="auth-section" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl transition-all duration-500 mb-8 max-w-lg mx-auto">
            <h2 id="auth-title" class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-2">Iniciar Sesi√≥n</h2>
            
            <!-- Formulario de LOGIN -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Usuario (Email)</label>
                    <input type="email" id="username" name="username" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" value="test@example.com">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" value="password">
                </div>
                <div id="register-fields" class="space-y-4 hidden">
                    <div>
                        <label for="reg-nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                        <input type="text" id="reg-nombre" name="nombre" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="reg-ciudad" class="block text-sm font-medium text-gray-700">Ciudad</label>
                        <input type="text" id="reg-ciudad" name="ciudad" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" value="Bogota">
                    </div>
                </div>
                <button type="submit" id="auth-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center justify-center">
                    <span id="auth-text">Acceder a la API</span>
                    <span id="auth-spinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full ml-2"></span>
                </button>
            </form>
            <div class="mt-4 text-sm text-center">
                <button id="toggle-auth-mode" class="text-blue-500 hover:text-blue-700">
                    ¬øNo tienes cuenta? Reg√≠strate aqu√≠.
                </button>
            </div>
        </section>

        <!-- SECCI√ìN 2: DATOS DE BICISUARIOS / MI PERFIL -->
        <div id="data-container" class="hidden">

            <!-- PESTA√ëAS -->
            <div class="flex space-x-2 border-b mb-6">
                <button id="tab-list" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300 transition duration-150" data-view="list">Listado Global</button>
                <button id="tab-profile" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300 transition duration-150" data-view="profile">Mi Perfil (CRUD)</button>
                <button onclick="logout()" class="ml-auto text-sm text-red-500 hover:text-red-700 font-medium transition duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-4a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Cerrar Sesi√≥n
                </button>
            </div>

            <!-- CONTENIDO DE LAS PESTA√ëAS -->
            <div id="view-list" class="view-content bg-white p-6 md:p-10 rounded-xl shadow-2xl">
                <div class="flex justify-between items-center border-b pb-2 mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">Listado de Biciusuarios (GET /biciusuarios/)</h2>
                    <button onclick="fetchBiciusuarios(true)" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg shadow-md flex items-center transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H6a1 1 0 011-1v-1a1 1 0 00-2 0v1H4a1 1 0 000 2h.001v.01zM16 10a1 1 0 011 1v2.101a7.002 7.002 0 01-11.601 2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H14a1 1 0 01-1-1v-1a1 1 0 002 0v1h1a1 1 0 000-2h-.001v-.01z" clip-rule="evenodd" />
                        </svg>
                        Refrescar Datos
                    </button>
                </div>
                
                <div id="biciusuarios-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-500 col-span-full" id="data-status">Cargando lista global...</p>
                </div>
            </div>

            <div id="view-profile" class="view-content hidden bg-white p-6 md:p-10 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-2">Mi Perfil (GET, PUT, DELETE /biciusuarios/<span id="profile-user-id" class="text-blue-500"></span>)</h2>
                
                <div id="profile-form-container">
                    <p class="text-gray-500 text-center py-8">Cargando datos del perfil...</p>
                    <!-- Formulario de edici√≥n inyectado aqu√≠ -->
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN Y UTILIDADES ---
        
        // CORRECCI√ìN CR√çTICA PARA CODESPACES/GITPOD:
        // Si el frontend est√° en el puerto X (ej. 5500 de Live Server), y la API en el puerto 5002,
        // Codespaces expone ambos con hostnames diferentes (ej. ...-5500.app.github.dev y ...-5002.app.github.dev).
        // Necesitamos reescribir el hostname del frontend al hostname del backend.
        const FLASK_PORT = '5002'; // El puerto donde corre la API de Flask

        function getApiBaseUrl() {
            const currentHostname = window.location.hostname; // ej. codespacename-5500.app.github.dev
            const currentProtocol = window.location.protocol;
            const currentPort = window.location.port;

            // 1. Detecci√≥n de entorno local (127.0.0.1 o localhost)
            if (currentHostname === 'localhost' || currentHostname === '127.0.0.1') {
                // En entorno local, la API est√° en el puerto FLASK_PORT
                const url = `${currentProtocol}//${currentHostname}:${FLASK_PORT}`;
                console.log("üõ†Ô∏è Entorno local detectado. API Base URL:", url);
                return url;
            }
            
            // 2. Detecci√≥n de Codespaces/Gitpod (usa el proxy de puertos)
            if (currentHostname.includes('.app.github.dev') || currentHostname.includes('.gitpod.io')) {
                // El hostname de Codespaces/Gitpod incluye un puerto al final (ej: codespacename-8000.app.github.dev)
                // Usamos una expresi√≥n regular m√°s robusta para reemplazar el puerto actual.
                let apiHostname = currentHostname.replace(/-\d+(\.app\.github\.dev|\.gitpod\.io)$/, `-${FLASK_PORT}$1`);
                
                // Si la regex no encuentra el puerto, puede ser un entorno m√°s simple (ej: puerto directo)
                if (apiHostname === currentHostname) {
                    apiHostname = currentHostname.replace(/:\d+$/, `:${FLASK_PORT}`);
                }

                const url = currentProtocol + '//' + apiHostname;
                console.log(`üõ†Ô∏è Entorno remoto (Codespaces) detectado. Hostname reescrito de: ${currentHostname} a: ${apiHostname}. API Base URL: ${url}`);
                return url;
            }

            // 3. Fallback gen√©rico (para cualquier otro entorno con puerto)
            const url = currentProtocol + '//' + currentHostname.replace(/:\d+/, `:${FLASK_PORT}`);
            console.log("üõ†Ô∏è Entorno gen√©rico detectado. API Base URL:", url);
            return url;
        }

        const API_BASE_URL = getApiBaseUrl();
        console.log("‚úÖ API Base URL final y en uso:", API_BASE_URL);

        
        const MESSAGE_BOX = document.getElementById('message-box');
        const AUTH_SECTION = document.getElementById('auth-section');
        const DATA_CONTAINER = document.getElementById('data-container');
        const BICIUSUARIOS_LIST = document.getElementById('biciusuarios-list');
        const LOGIN_FORM = document.getElementById('login-form');
        const AUTH_BTN = document.getElementById('auth-btn');
        const AUTH_TEXT = document.getElementById('auth-text');
        const AUTH_SPINNER = document.getElementById('auth-spinner');
        const REGISTER_FIELDS = document.getElementById('register-fields');
        const AUTH_TITLE = document.getElementById('auth-title');
        const TOGGLE_AUTH_MODE = document.getElementById('toggle-auth-mode');
        const PROFILE_FORM_CONTAINER = document.getElementById('profile-form-container');
        
        let isRegisterMode = false;
        let currentUserId = null;

        /** Muestra un mensaje temporal en la interfaz */
        function displayMessage(text, type = 'success') {
            MESSAGE_BOX.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'border', 'border-red-200', 'border-green-200', 'border-yellow-200');
            
            let classList = [];
            if (type === 'error') {
                classList = ['bg-red-100', 'text-red-800', 'border', 'border-red-200'];
            } else if (type === 'success') {
                classList = ['bg-green-100', 'text-green-800', 'border', 'border-green-200'];
            } else {
                classList = ['bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200'];
            }
            
            MESSAGE_BOX.classList.add(...classList);
            MESSAGE_BOX.textContent = text;
            MESSAGE_BOX.style.opacity = '1';
            
            setTimeout(() => {
                MESSAGE_BOX.style.opacity = '0';
                setTimeout(() => MESSAGE_BOX.classList.add('hidden'), 300);
            }, 5000);
        }

        /** Muestra/Oculta el overlay de carga global */
        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        /** Muestra/Oculta el spinner en el bot√≥n de autenticaci√≥n */
        function toggleLoadingButton(show) {
            AUTH_BTN.disabled = show;
            AUTH_SPINNER.classList.toggle('hidden', !show);
            AUTH_TEXT.classList.toggle('hidden', show);
        }

        /** Muestra/Oculta el spinner en el bot√≥n de actualizaci√≥n de perfil */
        function toggleUpdatingButton(show) {
            const updateBtn = document.getElementById('update-btn');
            const updateText = document.getElementById('update-text');
            const updateSpinner = document.getElementById('update-spinner');
            
            if (updateBtn && updateText && updateSpinner) {
                updateBtn.disabled = show;
                updateSpinner.classList.toggle('hidden', !show);
                updateText.classList.toggle('hidden', show);
            }
        }


        /** Renderiza el estado de la aplicaci√≥n (Login/Datos) */
        function renderState() {
            const token = localStorage.getItem('access_token');
            currentUserId = localStorage.getItem('user_id');

            if (token && currentUserId) {
                AUTH_SECTION.classList.add('hidden');
                DATA_CONTAINER.classList.remove('hidden');
                
                // Asegurar que la pesta√±a activa se muestre correctamente
                const activeTab = document.querySelector('.tab-button.border-blue-600') || document.getElementById('tab-list');
                showView(activeTab.dataset.view);

                // Forzar carga de datos de la lista y del perfil
                fetchBiciusuarios();
                fetchProfile(currentUserId);
            } else {
                AUTH_SECTION.classList.remove('hidden');
                DATA_CONTAINER.classList.add('hidden');
                toggleAuthMode(false); // Volver a modo Login si no hay token
                BICIUSUARIOS_LIST.innerHTML = '<p class="text-gray-500 col-span-full">Inicia sesi√≥n para cargar la lista.</p>';
            }
        }

        /** Cambia entre modo Login y Register */
        function toggleAuthMode(toRegister) {
            isRegisterMode = toRegister === undefined ? !isRegisterMode : toRegister;

            if (isRegisterMode) {
                AUTH_TITLE.textContent = 'Crear Nueva Cuenta';
                AUTH_TEXT.textContent = 'Registrar Biciusuario';
                REGISTER_FIELDS.classList.remove('hidden');
                TOGGLE_AUTH_MODE.textContent = '¬øYa tienes cuenta? Inicia Sesi√≥n.';
                LOGIN_FORM.removeEventListener('submit', handleLogin);
                LOGIN_FORM.addEventListener('submit', handleRegister);
                document.getElementById('reg-nombre').setAttribute('required', 'required');
                document.getElementById('reg-ciudad').setAttribute('required', 'required');

            } else {
                AUTH_TITLE.textContent = 'Iniciar Sesi√≥n';
                AUTH_TEXT.textContent = 'Acceder a la API';
                REGISTER_FIELDS.classList.add('hidden');
                TOGGLE_AUTH_MODE.textContent = '¬øNo tienes cuenta? Reg√≠strate aqu√≠.';
                LOGIN_FORM.removeEventListener('submit', handleRegister);
                LOGIN_FORM.addEventListener('submit', handleLogin);
                document.getElementById('reg-nombre').removeAttribute('required');
                document.getElementById('reg-ciudad').removeAttribute('required');
            }
        }
        
        // Asignar listener para cambiar modo
        TOGGLE_AUTH_MODE.addEventListener('click', () => toggleAuthMode());


        /** Maneja el proceso de Login */
        async function handleLogin(event) {
            event.preventDefault();
            toggleLoadingButton(true);

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginUrl = `${API_BASE_URL}/auth/login`;

            try {
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    // CR√çTICO: Guardar user_id junto con el token
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_id', data.user_id); 
                    
                    displayMessage('Sesi√≥n iniciada con √©xito. Token JWT guardado.', 'success');
                    renderState();
                } else {
                    const errorMsg = data.msg || data.message || 'Credenciales inv√°lidas.';
                    displayMessage(`Error al iniciar sesi√≥n: ${errorMsg}`, 'error');
                }

            } catch (error) {
                console.error('Error de red durante el login:', error);
                // Mensaje m√°s espec√≠fico para ayudar a la depuraci√≥n del usuario
                displayMessage('Error de conexi√≥n con el servidor. Verifique: 1) Que el backend de Flask est√© corriendo en el puerto 5002. 2) La URL de la API generada en la consola.', 'error');
            } finally {
                toggleLoadingButton(false);
            }
        }

        /** Maneja el proceso de Registro */
        async function handleRegister(event) {
            event.preventDefault();
            toggleLoadingButton(true);

            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const nombre = document.getElementById('reg-nombre').value;
            const ciudad = document.getElementById('reg-ciudad').value;
            
            const registerUrl = `${API_BASE_URL}/auth/register`;

            try {
                const response = await fetch(registerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, nombre_biciusuario: nombre, ciudad })
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage('Registro exitoso. ¬°Inicia sesi√≥n ahora!', 'success');
                    toggleAuthMode(false); // Volver a modo Login
                    document.getElementById('password').value = ''; // Limpiar contrase√±a
                } else {
                    const errorMsg = data.msg || data.message || 'Error desconocido al registrar.';
                    displayMessage(`Error al registrar: ${errorMsg}`, 'error');
                }

            } catch (error) {
                console.error('Error de red durante el registro:', error);
                // Mensaje m√°s espec√≠fico para ayudar a la depuraci√≥n del usuario
                displayMessage('Error de conexi√≥n con el servidor. Verifique: 1) Que el backend de Flask est√© corriendo en el puerto 5002. 2) La URL de la API generada en la consola.', 'error');
            } finally {
                toggleLoadingButton(false);
            }
        }

        /** Carga los datos de biciusuarios usando el token JWT (GET /biciusuarios) */
        async function fetchBiciusuarios(refresh = false) {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            const dataUrl = `${API_BASE_URL}/biciusuarios`;
            BICIUSUARIOS_LIST.innerHTML = '<p class="text-center text-blue-500 col-span-full">Cargando datos...</p>';

            try {
                const response = await fetch(dataUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const biciusuarios = await response.json();
                    renderBiciusuarios(biciusuarios);
                    if (refresh) {
                        displayMessage('Datos de biciusuarios refrescados.', 'success');
                    }
                } else if (response.status === 401) {
                    displayMessage('Token expirado o inv√°lido. Por favor, inicia sesi√≥n de nuevo.', 'error');
                    logout(); 
                } else {
                    const errorData = await response.json();
                    displayMessage(`Error al cargar los datos: ${errorData.msg || 'Error desconocido'}`, 'error');
                    BICIUSUARIOS_LIST.innerHTML = `<p class="text-center text-red-500 col-span-full">Error al cargar datos: ${errorData.msg || 'Verifique su token y permisos.'}</p>`;
                }

            } catch (error) {
                console.error('Error de red al cargar biciusuarios:', error);
                BICIUSUARIOS_LIST.innerHTML = '<p class="text-center text-red-500 col-span-full">Error de red. ¬øLa API est√° activa en 5002?</p>';
            }
        }

        /** Carga los datos del perfil del usuario actual (GET /biciusuarios/<id>) */
        async function fetchProfile(userId) {
            const token = localStorage.getItem('access_token');
            if (!token || !userId) return;

            const profileUrl = `${API_BASE_URL}/biciusuarios/${userId}`;
            PROFILE_FORM_CONTAINER.innerHTML = '<p class="text-gray-500 text-center py-8">Cargando datos del perfil...</p>';
            document.getElementById('profile-user-id').textContent = userId;

            try {
                const response = await fetch(profileUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const profileData = await response.json();
                    renderProfileForm(profileData);
                } else if (response.status === 401) {
                    displayMessage('Token expirado o inv√°lido. Por favor, inicia sesi√≥n de nuevo.', 'error');
                    logout(); 
                } else {
                    const errorData = await response.json();
                    displayMessage(`Error al cargar el perfil: ${errorData.msg || 'Error desconocido'}`, 'error');
                    PROFILE_FORM_CONTAINER.innerHTML = `<p class="text-center text-red-500 col-span-full">Error al cargar perfil: ${errorData.msg || 'Verifique su ID y permisos.'}</p>`;
                }

            } catch (error) {
                console.error('Error de red al cargar perfil:', error);
                PROFILE_FORM_CONTAINER.innerHTML = '<p class="text-center text-red-500 col-span-full">Error de red. ¬øLa API est√° activa en 5002?</p>';
            }
        }

        /** Renderiza la lista de biciusuarios en tarjetas */
        function renderBiciusuarios(data) {
            BICIUSUARIOS_LIST.innerHTML = '';
            
            if (!Array.isArray(data) || data.length === 0) {
                BICIUSUARIOS_LIST.innerHTML = '<p class="text-gray-500 col-span-full">No se encontraron biciusuarios.</p>';
                return;
            }

            data.forEach(user => {
                const bikeCount = user.bicicletas ? user.bicicletas.length : 0;
                const card = document.createElement('div');
                card.className = 'bg-gray-100 p-5 rounded-xl shadow-lg transition duration-300 transform hover:-translate-y-0.5 border-t-4 border-blue-500';
                card.innerHTML = `
                    <p class="text-xs font-mono text-gray-400 mb-2">ID: ${user.id || 'N/A'}</p>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">${user.nombre_biciusuario || 'Nombre no disponible'}</h3>
                    <p class="text-blue-600 font-medium mb-3">${user.email || 'Email no disponible'}</p>
                    <div class="flex items-center text-sm text-gray-600 space-x-4">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                            ${user.ciudad || 'Ciudad no especificada'}
                        </div>
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M11 5a2 2 0 10-4 0v2.102a2 2 0 001.347 1.834L10.5 10l-1.153 1.064A2 2 0 008 13.898V16a2 2 0 104 0v-2.102a2 2 0 00-1.347-1.834L9.5 10l1.153-1.064A2 2 0 0012 6.102V5z" />
                                <path fill-rule="evenodd" d="M12.316 4.34a1 1 0 011.082-.239 6 6 0 013.166 4.417 1 1 0 01-1.082 1.239 1 1 0 01-.238-1.082 4 4 0 00-2.094-2.94 1 1 0 01-.772-.882V5z" clip-rule="evenodd" />
                            </svg>
                            ${bikeCount} Bicicleta${bikeCount !== 1 ? 's' : ''}
                        </div>
                    </div>
                `;
                BICIUSUARIOS_LIST.appendChild(card);
            });
        }
        
        /** Renderiza el formulario de edici√≥n de perfil */
        function renderProfileForm(user) {
            // Asume que bicicletas es un array de objetos o null/undefined
            const bicicletasJson = JSON.stringify(user.bicicletas || [], null, 2);

            PROFILE_FORM_CONTAINER.innerHTML = `
                <form id="profile-edit-form" class="space-y-6">
                    <!-- ID y Email (solo lectura) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ID (Usuario)</label>
                            <input type="text" value="${user.id || 'N/A'}" readonly class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg shadow-sm cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" value="${user.email || 'N/A'}" readonly class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg shadow-sm cursor-not-allowed">
                        </div>
                    </div>
                    
                    <!-- Nombre y Ciudad (editable) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-nombre" class="block text-sm font-medium text-gray-700">Nombre de Biciusuario</label>
                            <input type="text" id="edit-nombre" name="nombre_biciusuario" value="${user.nombre_biciusuario || ''}" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="edit-ciudad" class="block text-sm font-medium text-gray-700">Ciudad</label>
                            <input type="text" id="edit-ciudad" name="ciudad" value="${user.ciudad || ''}" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- Bicicletas (JSON editable) -->
                    <div>
                        <label for="edit-bicicletas" class="block text-sm font-medium text-gray-700 flex justify-between items-center">
                            Bicicletas (Formato JSON Array de Objetos)
                            <span class="text-xs text-red-500 font-normal">¬°Cuidado al editar este campo!</span>
                        </label>
                        <textarea id="edit-bicicletas" name="bicicletas" rows="6" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-inner font-mono text-sm focus:ring-blue-500 focus:border-blue-500">${bicicletasJson}</textarea>
                        <p class="text-xs text-gray-500 mt-1">Ejemplo: \`[{"modelo": "Trek", "color": "Rojo"}, {"modelo": "Specialized", "color": "Azul"}]\`</p>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="flex justify-end space-x-4 pt-4 border-t">
                        <button type="button" id="delete-btn" class="flex items-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            Eliminar Cuenta (DANGER)
                        </button>
                        <button type="submit" id="update-btn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                            <span id="update-text">Guardar Cambios (PUT)</span>
                            <span id="update-spinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full ml-2"></span>
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('profile-edit-form').addEventListener('submit', handleUpdateProfile);
            document.getElementById('delete-btn').addEventListener('click', handleDeleteProfile);
        }

        /** Maneja la actualizaci√≥n de perfil (PUT /biciusuarios/<id>) */
        async function handleUpdateProfile(event) {
            event.preventDefault();
            toggleUpdatingButton(true);

            const token = localStorage.getItem('access_token');
            const userId = localStorage.getItem('user_id');
            
            const nombre = document.getElementById('edit-nombre').value;
            const ciudad = document.getElementById('edit-ciudad').value;
            const bicicletasJson = document.getElementById('edit-bicicletas').value;
            let bicicletas;

            try {
                // 1. Parsear el JSON de bicicletas
                bicicletas = JSON.parse(bicicletasJson);

                // 2. Construir el cuerpo de la solicitud (solo campos modificables)
                const updateData = {
                    nombre_biciusuario: nombre,
                    ciudad: ciudad,
                    bicicletas: bicicletas 
                };

                const updateUrl = `${API_BASE_URL}/biciusuarios/${userId}`;

                const response = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage('Perfil actualizado con √©xito.', 'success');
                    // Refrescar el perfil despu√©s de la actualizaci√≥n
                    fetchProfile(userId);
                    // Refrescar la lista global tambi√©n
                    fetchBiciusuarios();
                } else if (response.status === 401) {
                    displayMessage('Sesi√≥n expirada. Inicie sesi√≥n de nuevo.', 'error');
                    logout();
                } else {
                    displayMessage(`Error al actualizar: ${data.msg || 'Error desconocido'}`, 'error');
                }

            } catch (e) {
                if (e instanceof SyntaxError) {
                    displayMessage('Error: El campo Bicicletas no es un JSON v√°lido. Debe ser un array de objetos.', 'error');
                } else if (e instanceof TypeError && e.message.includes('fetch')) {
                    console.error('Error de red durante la actualizaci√≥n:', e);
                    displayMessage('Error de conexi√≥n con el servidor. Verifique que el backend est√© activo.', 'error');
                } else {
                    console.error('Error general durante la actualizaci√≥n:', e);
                    displayMessage('Error general al intentar actualizar el perfil.', 'error');
                }
            } finally {
                toggleUpdatingButton(false);
            }
        }
        
        /** Maneja la eliminaci√≥n de perfil (DELETE /biciusuarios/<id>) */
        async function handleDeleteProfile() {
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                displayMessage('No hay usuario logueado.', 'error');
                return;
            }

            // Implementaci√≥n de modal de confirmaci√≥n simple (reemplaza alert)
            if (!window.confirm('¬øEst√°s seguro de que quieres ELIMINAR tu cuenta? Esta acci√≥n es irreversible.')) {
                return;
            }
            
            toggleLoading(true);

            const token = localStorage.getItem('access_token');
            const deleteUrl = `${API_BASE_URL}/biciusuarios/${userId}`;

            try {
                const response = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    displayMessage('Cuenta eliminada con √©xito. Redirigiendo a Login.', 'success');
                    logout(); // Cierra sesi√≥n autom√°ticamente
                } else if (response.status === 401) {
                    displayMessage('Sesi√≥n expirada. Inicie sesi√≥n de nuevo.', 'error');
                    logout();
                } else {
                    const errorData = await response.json();
                    displayMessage(`Error al eliminar la cuenta: ${errorData.msg || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('Error de red durante la eliminaci√≥n:', error);
                displayMessage('Error de conexi√≥n con el servidor. Verifique que el backend est√© activo.', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        /** Cierra la sesi√≥n del usuario */
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            displayMessage('Sesi√≥n cerrada.', 'info');
            renderState();
        }

        // --- MANEJO DE VISTAS (PESTA√ëAS) ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => showView(e.target.dataset.view));
        });

        function showView(viewName) {
            // Actualizar botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-600');
                if (btn.dataset.view === viewName) {
                    btn.classList.add('border-blue-600', 'text-blue-600');
                    btn.classList.remove('border-transparent', 'text-gray-600');
                }
            });

            // Actualizar contenido
            document.querySelectorAll('.view-content').forEach(content => {
                content.classList.add('hidden');
                if (content.id === `view-${viewName}`) {
                    content.classList.remove('hidden');
                }
            });

            // Recargar datos si es necesario
            if (viewName === 'list') {
                fetchBiciusuarios();
            } else if (viewName === 'profile' && currentUserId) {
                fetchProfile(currentUserId);
            }
        }


        // --- INICIALIZACI√ìN ---
        LOGIN_FORM.addEventListener('submit', handleLogin);
        renderState(); // Inicia el estado de la aplicaci√≥n
    </script>
</body>
</html>
